name: Integration Tests with CDDA Data

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies (Linux only)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgl1 \
            libegl1 \
            libgles2 \
            libegl-mesa0 \
            libgbm1 \
            libxkbcommon-x11-0 \
            libxcb-icccm4 \
            libxcb-image0 \
            libxcb-keysyms1 \
            libxcb-randr0 \
            libxcb-render-util0 \
            libxcb-shape0 \
            libxcb-xfixes0 \
            libxcb-xinerama0 \
            libxcb-xkb1 \
            libxcb-cursor0 \
            libdbus-1-3 \
            libfontconfig1 \
            libfreetype6

      - name: Checkout CDDA repository
        uses: actions/checkout@v4
        with:
          repository: CleverRaven/Cataclysm-DDA
          path: ./CDDA
          # Shallow clone to save time/bandwidth
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        env:
          QT_QPA_PLATFORM: offscreen
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run integration tests
        env:
          QT_QPA_PLATFORM: offscreen
        run: |
          if [ -d "tests/integration" ] && [ "$(ls -A tests/integration)" ]; then
            export CDDA_PATH=./CDDA
            pytest tests/integration/ -v \
              -o log_cli=true -o log_cli_level=INFO
          else
            echo "No integration tests found, skipping"
          fi

      - name: Test game_data service with real CDDA data
        env:
          QT_QPA_PLATFORM: offscreen
        run: |
          python << 'EOF'
          from pathlib import Path
          from cdda_maped.game_data.service import GameDataService
          from cdda_maped.settings.core import AppSettings

          cdda_path = Path('./CDDA')
          if cdda_path.exists():
              settings = AppSettings()
              settings.always_include_core = True
              service = GameDataService(game_path=str(cdda_path), settings=settings)

              # Quick sanity checks
              terrain = service.get_objects_by_type('terrain')
              furniture = service.get_objects_by_type('furniture')

              print(f"✓ Loaded {len(terrain)} terrain objects")
              print(f"✓ Loaded {len(furniture)} furniture objects")

              # Try to get specific object
              t_floor = service.get_resolved_object('t_floor')
              if t_floor:
                  print(f"✓ Successfully loaded object: {t_floor.get('id')}")
              else:
                  print("✗ Could not find t_floor terrain")
          else:
              print("CDDA repository not found at ./CDDA")
          EOF
